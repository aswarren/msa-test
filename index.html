<html>

<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" type='image/x-icon' href="/favicon.ico">
    <meta name="description" content="Simple BioJS example" />

    <!-- include MSA js + css -->
    <!--    <script src="/js/dojo/dojo.js"></script> -->
    <script src="/js/msa/msa.js"></script>
    <!-- <script src="/public/patric_msa_js/src/msa.js"></script> -->

</head>

<body>

    <div id="menuDiv"></div>
    <div id="msaDiv">Loading ... </div>

    <script>
        // this is a way how you use a bundled file parser
        var msa = require("msa");
            
        var opts = {};

    // set your custom properties
    // @see: https://github.com/greenify/biojs-vis-msa/tree/master/src/g
    opts.el = msaDiv;//document.getElementById("msaDiv");
    opts.bootstrapMenu=false;
    opts.vis = {
        conserv: false,
        overviewbox: false,
        seqlogo: true
    };
    opts.conf = {
        dropImport: true
    };
    opts.zoomer = {
        menuFontsize: "12px",
        autoResize: true,
        labelNameLength: 150
    };

    // init msa
    var m = new msa.msa(opts);

    // search in URL for fasta or clustal
    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
    }

    function importText(text){
        var fileName, objs, ref, type;
        ref = this.parseText(text), objs = ref[0], type = ref[1];
        if (type === "error") {
        return "error";
        }
        if (type === "seqs") {
        this.msa.seqs.reset(objs);
        this.msa.g.config.set("url", "userimport");
        this.msa.g.trigger("url:userImport");
        } else if (type === "features") {
        this.msa.seqs.addFeatures(objs);
        } else if (type === "newick") {
        this.msa.u.tree.loadTree((function(_this) {
            return function() {
            return _this.msa.u.tree.showTree(file);
            };
        })(this));
        }
        return
    }
    //create a clustalw format string that can be passed to biojs msa
    function clustalData(data){
        var input=data.slice(5);
        var clustal=["CLUSTAL"];
        var orgs=[];
        for (var i = 0; i < input.length-2; i+=3) {
            clustal.push(input[i]+"\t"+input[i+2]);
            orgs.push(input[i+1]);
        }
        return ([clustal,orgs]);
    }
    var nexusData= ["11", "11", "39", "53", "(((fig|1310754.3.peg.2921:0.0,fig|1310727.3.peg.2939:0.0):1.17036,(fig|47716.4.peg.2238:0.11103,fig|66869.3.peg.5501:0.00641):0.99240):2.47910,((fig|1310683.3.peg.2856:0.0,fig|1310905.3.peg.2925:0.0):1.28000,fig|1235820.4.peg.2163:0.69592):2.18740,(((fig|321314.9.peg.37:0.0,fig|476213.4.peg.33:0.0):0.29056,fig|936157.3.peg.4962:0.43338):2.89151,fig|882800.3.peg.6267:0.00016):0.00019);", "fig|1310683.3.peg.2856", "Acinetobacter_baumannii_1566109", "--------MRFLQRYPSYQDFYCRFDVICF-DFPQKIAKTVQQDFSK-FHYDLQWIENVFTLD--", "fig|1310905.3.peg.2925", "Acinetobacter_baumannii_25977_1", "--------MRFLQRYPSYQDFYCRFDVICF-DFPQKIAKTVQQDFSK-FHYDLQWIENVFTLD--", "fig|1235820.4.peg.2163", "Prevotella_oris_JCM_12252", "-----------MKERAIWDDL--RFDLISI-------VGTAPENFK------LEHIVDAFNPLLV", "fig|321314.9.peg.37", "Salmonella_enterica_subsp._enterica_serovar_Choleraesuis_str._SC-B67", "MSSPGNPGKTSDGRHTEVGSF--NYSRAAD-RSNSENVLSSGMTQS-------------------", "fig|476213.4.peg.33", "Salmonella_enterica_subsp._enterica_serovar_Paratyphi_C_strain_RKS4594", "MSSPGNPGKTSDGRHTEVGSF--NYSRAAD-RSNSENVLSSGMTQS-------------------", "fig|936157.3.peg.4962", "Salmonella_enterica_subsp._enterica_serovar_Weltevreden_str._2007-60-3289-1", "-------MIVADGRNTQVGSF--NFSRAAD-RSNSENVLVVWDDPVLARSYLNHWTSR-------", "fig|1310754.3.peg.2921", "Acinetobacter_baumannii_2887", "-----------MLVAQQLGQW--AEQTALK-LLKEQNYEWVASNYHS-RRGEVDLIENAVTN---", "fig|1310727.3.peg.2939", "Acinetobacter_baumannii_836190", "-----------MLVAQQLGQW--AEQTALK-LLKEQNYEWVASNYHS-RRGEVDLIENAVTN---", "fig|882800.3.peg.6267", "Methylobacterium_extorquens_DSM_13060", "-----------MSRAAR--AWLARHPLAADATLRADAVFVAPRRWPR-------HLPNAFEIEGL", "fig|47716.4.peg.2238", "Streptomyces_olivaceus", "-----------MNARSALGRY--GETLAAR-RLADAGMTVLERNWRCGRTGEIDIVARDKQDELH", "fig|66869.3.peg.5501", "Streptomyces_atroolivaceus", "-----------MNARGALGRY--GEDLAAR-LLADAGMTVLDRNWRC-RTGEIDIVARDEQDELH"]
    var replacement=[];
    nexusData.forEach(function(item){replacement.push(item.replace(/\|/g, "."));}, this);
    nexusData=replacement;
    var clustal,orgs;
    var inputData= clustalData(nexusData), clustal=inputData[0], orgs=inputData[1];

    //m.u.file.parseText(test, renderMSA);

    //importText.bind(this.m.u.file)(test);
    m.u.file.importFile(nexusData[4]);
    m.u.file.importFile(clustal.join("\n"));
    renderMSA();
    function renderMSA() {
            // the menu is independent to the MSA container
            var menuOpts = {};
            menuOpts.el = document.getElementById('menuDiv');
            menuOpts.msa = m;
            var defMenu = new msa.menu.defaultmenu(menuOpts);

            var noMenu = ["10_import", "15_ordering", "20_filter", "30_selection", "70_extra", "90_help", "95_debug"];
            noMenu.forEach(function(toRemove){delete defMenu.views[toRemove];});
            m.addView("menu", defMenu);
            // call render at the end to display the whole MSA
            m.render();
            m.el.parentElement.insertBefore(menuOpts.el, m.el);
        }
    </script>

</body>

</html>

